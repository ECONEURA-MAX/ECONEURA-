name: Deploy Backend to Azure (Production)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/azure-backend-prod.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: econeura-backend-prod
  NODE_VERSION: '20.x'
  AZURE_RESOURCE_GROUP: econeura-resources

jobs:
  build:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies (production only)
      working-directory: backend
      run: |
        echo "ðŸ“¦ Installing production dependencies..."
        npm ci --omit=dev --ignore-scripts
        echo "âœ… Dependencies installed"

    - name: Run tests
      working-directory: backend
      run: |
        npm install --save-dev jest supertest @types/jest
        npm test
        npm run lint || true

    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        cd backend
        
        # Remove dev files
        rm -rf tests __tests__ coverage *.test.js *.spec.js
        rm -rf logs/*.log
        
        # Create zip
        zip -r ../backend-prod.zip . \
          -x "*.git*" \
          -x "*coverage*" \
          -x "*__tests__*" \
          -x "*.test.js" \
          -x "*.spec.js" \
          -x "*.log" \
          -x "uploads/*" \
          -x "backups/*" \
          -x "data/*" \
          -x "*.db" \
          -x "*.sqlite"
        
        cd ..
        ls -lh backend-prod.zip
        echo "âœ… Package created"

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: backend-package
        path: backend-prod.zip
        retention-days: 7

  deploy:
    name: Deploy to Azure
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: backend-package

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: backend-prod.zip

    - name: Wait for deployment
      run: sleep 60

    - name: Health check
      run: |
        echo "ðŸ¥ Running health check..."
        HEALTH_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health"
        
        for i in {1..5}; do
          echo "Attempt $i/5..."
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "âœ… Health check passed"
            curl -s "$HEALTH_URL" | jq .
            exit 0
          fi
          sleep 10
        done
        
        echo "âš ï¸ Health check failed but continuing..."
        exit 0

    - name: Azure logout
      if: always()
      run: az logout

  notify:
    name: Notify Deployment
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "## ðŸš€ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "**Health Check:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deploy:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY


