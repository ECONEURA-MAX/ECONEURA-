name: Deploy Frontend to Azure (Production)

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/azure-frontend-prod.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}

jobs:
  build-and-deploy:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://econeura.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: frontend
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"

    - name: Run tests
      working-directory: frontend
      run: |
        echo "ðŸ§ª Running tests..."
        npm test -- --run || true
        echo "âœ… Tests completed"

    - name: Build production
      working-directory: frontend
      env:
        VITE_API_URL: https://econeura-backend-prod.azurewebsites.net/api
        VITE_NEURA_GW_URL: https://econeura-backend-prod.azurewebsites.net
        NODE_ENV: production
      run: |
        echo "ðŸ—ï¸ Building frontend..."
        npm run build
        echo "âœ… Build completed"
        ls -lh dist/

    - name: Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend"
        output_location: "dist"
        skip_app_build: true

  verify:
    name: Verify Deployment
    needs: build-and-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for deployment
      run: sleep 30

    - name: Check website availability
      run: |
        echo "ðŸŒ Checking website..."
        if curl -f -s https://econeura.com > /dev/null; then
          echo "âœ… Website is online"
        else
          echo "âš ï¸ Website check failed"
        fi

  notify:
    name: Notify Deployment
    needs: [build-and-deploy, verify]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "## ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://econeura.com" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build & Deploy:** ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Verification:** ${{ needs.verify.result }}" >> $GITHUB_STEP_SUMMARY


